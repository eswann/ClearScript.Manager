<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        .CodeMirror {
            font-family: Monaco, 'Andale Mono', 'Lucida Console', 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace !important;
            font-size: 14px;
        }

        .CodeMirror, #codeForm {
            height: 100% !important;
        }

        .breakpoints {
            width: .8em;
        }

        .breakpoint {
            color: #822;
        }

        .cm-matchhighlight {
            background-color: rgb(204, 174, 248)
        }

        .CodeMirror-selection-highlight-scrollbar {
            background-color: rgb(166, 109, 249)
        }

        .cm-mustache {
            color: #e46d31;
        }
    </style>
    <script src="resources/jquery-2.1.3.js"></script>
    <link rel="stylesheet" href="resources/codemirror/lib/codemirror.css">
    <script src="resources/codemirror/lib/codemirror.js"></script>
    <link rel="stylesheet" href="resources/codemirror/theme/eclipse.css">
    <script src="resources/codemirror/addon/hint/show-hint.js"></script>
    <script src="resources/codemirror/addon/edit/closetag.js"></script>
    <script src="resources/codemirror/addon/edit/closebrackets.js"></script>
    <script src="resources/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="resources/codemirror/addon/selection/active-line.js"></script>
    <script src="resources/codemirror/addon/runmode/runmode.js"></script>
    <script src="resources/codemirror/mode/javascript/javascript.js"></script>
    <script src="resources/ternjs/acorn/acorn.js"></script>
    <script src="resources/ternjs/acorn/acorn_loose.js"></script>
    <script src="resources/ternjs/acorn/util/walk.js"></script>
    <script src="resources/ternjs/tern/lib/signal.js"></script>
    <script src="resources/ternjs/tern/lib/tern.js"></script>
    <script src="resources/ternjs/tern/lib/def.js"></script>
    <script src="resources/ternjs/tern/lib/comment.js"></script>
    <script src="resources/ternjs/tern/lib/infer.js"></script>
    <script src="resources/tabris.js"></script>
    <script src="resources/codemirror/addon/tern/tern.js"></script>
    <link rel="stylesheet" href="resources/codemirror-javascript/addon/hint/tern/tern-extension.css">
    <script src="resources/codemirror-javascript/addon/hint/tern/tern-extension.js"></script>
    <script src="resources/codemirror-javascript/addon/hint/tern/defs/ecma5.json.js"></script>
    <script src="resources/codemirror-javascript/addon/hint/tern/defs/browser.json.js"></script>
    <script src="resources/codemirror-javascript/addon/hint/tern/defs/underscore.json.js"></script>
    <script src="resources/codemirror-javascript/addon/hint/tern/defs/jquery.json.js"></script>

    <link rel="stylesheet" href="resources/codemirror-extension/addon/hint/show-hint-eclipse.css">
    <script src="resources/codemirror-extension/addon/hint/show-context-info.js"></script>
    <link rel="stylesheet" href="resources/codemirror-extension/addon/hint/show-context-info.css">
    <link rel="stylesheet" href="resources/codemirror-extension/addon/hint/templates-hint.css">
    <script src="resources/codemirror-extension/addon/hint/templates-hint.js"></script>
    <script src="resources/codemirror-javascript/addon/hint/javascript/javascript-templates.js"></script>
    <script src="resources/codemirror/addon/hint/javascript/javascript-hint.js"></script>
    <link rel="stylesheet" href="resources/codemirror/doc/docs.css">
    <script src="resources/codemirror/addon/hint/javascript/tabris-templates.js"></script>
    <script src="resources/codemirror/addon/hint/context-autocomplete-hint.js"></script>
    <script src="resources/codemirror-extension/addon/util/formatting.js"></script>


    <link href="resources/codemirror/addon/dialog/dialog.css" rel="stylesheet" />
    <script src="resources/codemirror/addon/dialog/dialog.js"></script>
    <link href="resources/codemirror/addon/search/dialog.css" rel="stylesheet" />
    <script src="resources/codemirror/addon/scroll/annotatescrollbar.js"></script>
    <script src="resources/codemirror/addon/search/jump-to-line.js"></script>
    <script src="resources/codemirror/addon/search/matchesonscrollbar.js"></script>
    <script src="resources/codemirror/addon/search/search.js"></script>
    <script src="resources/codemirror/addon/search/searchcursor.js"></script>
    <script src="resources/codemirror/addon/search/match-highlighter.js"></script>


    <link href="resources/codemirror/addon/lint/lint.css" rel="stylesheet" />
    <script src="resources/codemirror/addon/lint/jshint.js"></script>
    <script src="resources/codemirror/addon/lint/jsonlint.js"></script>
    <script src="resources/codemirror/addon/lint/lint.js"></script>
    <script src="resources/codemirror/addon/lint/javascript-lint.js"></script>
    <script src="resources/codemirror/addon/lint/json-lint.js"></script>

    <link href="resources/codemirror/addon/scroll/simplescrollbars.css" rel="stylesheet" />
    <script src="resources/codemirror/addon/scroll/simplescrollbars.js"></script>

    <link href="resources/codemirror/addon/fold/foldgutter.css" rel="stylesheet" />
    <script src="resources/codemirror/addon/fold/foldcode.js"></script>
    <script src="resources/codemirror/addon/fold/foldgutter.js"></script>
    <script src="resources/codemirror/addon/fold/brace-fold.js"></script>
    <script src="resources/codemirror/addon/fold/comment-fold.js"></script>
    <script src="resources/codemirror/addon/fold/indent-fold.js"></script>


    <link rel="stylesheet" href="resources/codemirror-extension/addon/hover/text-hover.css">
        <script src="resources/codemirror-extension/addon/hover/text-hover.js"></script>
        <script src="resources/codemirror-javascript/addon/hint/tern/tern-hover.js"></script>
    <script type="text/javascript">
        var _setTimer = undefined;
        $(function () {
            window.cmEditor = window.cmEditor || {};
            cmEditor.editor = CodeMirror.fromTextArea(document.getElementById("code"),
                {
                    mode: "application/javascript",
                    theme: "eclipse",
                    styleActiveLine: !0,
                    lineNumbers: !0,
                    lineWrapping: !0,
                    autoCloseBrackets: !0,
                    matchBrackets: !0,
                    extraKeys: {
                        "'.'": function (a) {
                            setTimeout(function () { CodeMirror.showHint(a, CodeMirror.ternHint, { async: !0 }) }, 100);
                            return CodeMirror.Pass;
                        },
                        "Alt-/": "contextAutocomplete",
                        "Ctrl-I": function (a) { CodeMirror.tern.showType(a) },
                        "Alt-.": function (a) { CodeMirror.tern.jumpToDef(a) },
                        "Alt-,": function (a) { CodeMirror.tern.jumpBack(a) },
                        "Ctrl-Q": function (a) { CodeMirror.tern.rename(a) },
                        "Alt-\\": function (a) { cmEditor.editor.off("cursorActivity", autoComplete);cmEditor.editor.showHint({isFunc:true}) },
                        "Ctrl-S": function (a) {
							try{csharpJsFunction && csharpJsFunction.Save(getCode());}catch(e){}
						},
                        "Ctrl-/": function (a) {
                            commentSelection(true);
                        },
                        "Ctrl-Alt-/": function (a) {
                            commentSelection(false);
                        },
                        "Ctrl-Alt-C": function (a) {
                            autoFormatSelection();
                        },
                        "F2": function (a) {
                            var sele = getSelectedCode();
                            if (sele && sele.length > 0) {
                                try{(csharpJsFunction && csharpJsFunction.ExcuteSelected(sele));}catch(e){}
                            } else {
                                try{(csharpJsFunction && csharpJsFunction.Excute(getCode()));}catch(e){}
                            }
                        },
                        "F5": function (a) {
                            try{(csharpJsFunction && csharpJsFunction.DebuggerExcute(getCode()));}catch(e){}
                        }
                    },
                    gutters: ["CodeMirror-lint-markers", "CodeMirror-foldgutter","CodeMirror-linenumbers", "breakpoints"],
                    highlightSelectionMatches: { showToken: /\w/, annotateScrollbar: true },
                    textHover: { delay: 1000 },
                    ternWith: { plugins: { tabris: {} } },
                    lint: {
                        esversion: 6
                    },
                    scrollbarStyle: "simple",
                    foldGutter: true,
                });
            CodeMirror.cm =cmEditor.editor;
            cmEditor.editor.on("gutterClick", function (cm, n) {
				try{
					var info = cm.lineInfo(n);
					if (info.handle && info.handle.text.trim().length === 0) return;
					var breakpoint = (csharpJsFunction && csharpJsFunction.SetBreakpoint(info.line));
					if (breakpoint != -1) {
						cm.setGutterMarker(n, "breakpoints", info.gutterMarkers ? null : makeMarker());
					}
				}catch(e){}
            });

            function onChange(cm, textChanged){
                cm.off("cursorActivity", autoComplete);
//console.log('textChanged',textChanged);
                (_setTimer && clearTimeout(_setTimer));
                if (!textChanged.origin || textChanged.text.length ==0 || textChanged.origin == '+delete' || textChanged.origin == '+undo') {
                    return;
                }

                if(textChanged.origin === '+input'){
                    if(textChanged.text.length == 1){
                        if (textChanged.text[0].trim().length == 0 || textChanged.text[0] == ':' || textChanged.text[0] == ',' || textChanged.text[0] == '\''  || textChanged.text[0] == ';'  || textChanged.text[0] == '=' || textChanged.text[0] == '{}'){
                            return;
                        }
                    }else if(textChanged.text.length == 2){
                        if(textChanged.text[0].trim().length == 0 && textChanged.text[1].trim().length == 0){
                            return;
                        }
                    }
                }

                _setTimer = setTimeout(function(){
                    cm.on("cursorActivity", autoComplete);
                }, 100);
            };
            cmEditor.editor.tabrisOnchange = onChange;
            cmEditor.editor.on('change',cmEditor.editor.tabrisOnchange);


            function autoComplete(cm) {

                if (cm.showHitTime > 0) {
                    cm.showHitTime = 0;
                    return;
                }
                //调用显示提示
                CodeMirror.showHint(cm, CodeMirror.ternHint, { async: !0 })
                cm.off("cursorActivity", autoComplete);

            }
            cmEditor.editor.tabrisAutoComplete = autoComplete;
            function makeMarker() {
                var marker = document.createElement("div");
                marker.style.color = "#822";
                marker.innerHTML = "●";
                return marker;
            }
            $(document).keydown(function (event) {
                (_setTimer && clearTimeout(_setTimer));
                cmEditor.editor.off("change",cmEditor.editor.tabrisOnchange);
                //Ctrl +V
                if (event.ctrlKey && event.keyCode == 86) {
                    try{(csharpJsFunction && csharpJsFunction.Modify());}catch(e){}
                }
                else if (event.ctrlKey && event.keyCode == 90) { //Ctrl +Z
                    try{(csharpJsFunction && csharpJsFunction.Modify());}catch(e){}
                }
                else if (event.ctrlKey) {

                } else if (event.keyCode >= 116 && event.keyCode <= 123) {
                    //F1-12
                }else if (event.keyCode >= 49 && event.keyCode <= 57) {
                    //英文键盘上的数字键
                    try{(csharpJsFunction && csharpJsFunction.Modify());}catch(e){}
                }else if (event.keyCode >= 96 && event.keyCode <= 105) {
                    //小键盘的数字键
                    try{(csharpJsFunction && csharpJsFunction.Modify());}catch(e){}
                }
                else if (event.keyCode > 32 && event.keyCode <= 40) {
                    cmEditor.editor.off("cursorActivity",autoComplete);
                    try{(csharpJsFunction && csharpJsFunction.Modify());}catch(e){}
                } else if (event.keyCode == 32) {
                    cmEditor.editor.off("cursorActivity",autoComplete);
                    //SPACE
                    try{(csharpJsFunction && csharpJsFunction.Modify());}catch(e){}
                }else if (event.keyCode == 13) {
                    cmEditor.editor.off("cursorActivity",autoComplete);
                    //Enter
                    try{(csharpJsFunction && csharpJsFunction.Modify());}catch(e){}
                } else {
                    cmEditor.editor.on("change",cmEditor.editor.tabrisOnchange);
                    try{(csharpJsFunction && csharpJsFunction.Modify());}catch(e){}
                }
            });
        });

        function getCode() {
            return window.cmEditor.editor.getValue();
        }

        function getSelectedCode() {
            return window.cmEditor.editor.getSelection();
        }

        function setCode(code) {
            window.cmEditor.editor.setValue(Base64.decode(code));
        }

        function insertCode(code) {
            window.cmEditor.editor.replaceRange(Base64.decode(code),
                CodeMirror.Pos(window.cmEditor.editor.getCursor().line, window.cmEditor.editor.getCursor().ch));
        }

        function getPasteCode() {
            var selected = getSelectedCode();
            if (selected && selected.length) {
                return selected;
            } else {
                return getCode();
            }
        }

        function getSelectedRange() {
            return { from: window.cmEditor.editor.getCursor(true), to: window.cmEditor.editor.getCursor(false) };
        }

        function autoFormatSelection() {
            var range = getSelectedRange();
            if (range.from.line == range.to.line && range.from.ch == range.to.ch) return;
            window.cmEditor.editor.autoFormatRange(range.from, range.to);
        }

        function commentSelection(isComment) {
            var range = getSelectedRange();
            window.cmEditor.editor.commentRange(isComment, range.from, range.to);
        }
    </script>
</head>
<body>
    <form id="codeForm">
        <textarea id="code" name="code"></textarea>
    </form>
</body>
</html>
